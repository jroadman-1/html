<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cylindrical Profile Generator - Table Entry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .section { margin-bottom: 30px; }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-group { display: flex; flex-direction: column; }
        label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        input[type="number"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="number"]:focus { outline: none; border-color: #007bff; }
        canvas {
            display: block;
            background: white;
            border: 1px solid #ccc;
            margin: 20px auto;
        }
        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .button-primary { background: #007bff; color: white; }
        .button-primary:hover { background: #0056b3; }
        .button-secondary { background: #6c757d; color: white; }
        .button-secondary:hover { background: #545b62; }
        .button-success { background: #28a745; color: white; }
        .button-success:hover { background: #218838; }
        .button-success:disabled { background: #ccc; cursor: not-allowed; }
        .button-danger { background: #dc3545; color: white; font-size: 12px; padding: 6px 12px; }
        .button-danger:hover { background: #c82333; }
        .info-panel {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .info-row:last-child { border-bottom: none; }
        .instructions {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1565C0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        thead {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .point-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .point-input:focus {
            outline: none;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cylindrical Profile Generator</h1>
        <p class="subtitle">Define your profile with coordinate points and generate G-code for 4-axis cylindrical turning</p>
        
        <div class="section">
            <div class="section-title">1. Machine Parameters</div>
            <div class="controls">
                <div class="control-group">
                    <label for="toolDiameter">Tool Diameter (inches):</label>
                    <input type="number" id="toolDiameter" value="0.09375" step="0.001" min="0.001">
                </div>
                <div class="control-group">
                    <label for="spindleRPM">Spindle RPM:</label>
                    <input type="number" id="spindleRPM" value="18000" step="100" min="100">
                </div>
                <div class="control-group">
                    <label for="aAxisSpeed">A-axis Speed (deg/min):</label>
                    <input type="number" id="aAxisSpeed" value="3600" step="100" min="100">
                </div>
                <div class="control-group">
                    <label for="feedRate">Feed Rate (IPM):</label>
                    <input type="number" id="feedRate" value="10" step="0.1" min="0.1">
                </div>
                <div class="control-group">
                    <label for="depthPerPass">Z Depth per Pass (inches):</label>
                    <input type="number" id="depthPerPass" value="0.020" step="0.001" min="0.001">
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">2. Define Profile Points</div>
            <div class="instructions">
                <strong>Instructions:</strong> Enter coordinates to define your cylindrical profile. 
                Z = position along the cylinder axis (left to right), Radius = distance from centerline.
                Add points in order from one end to the other to create your profile outline.
            </div>
            
            <button class="button button-primary" id="addPointBtn">Add Point</button>
            <button class="button button-secondary" id="clearPointsBtn">Clear All</button>
            
            <div style="overflow-x: auto; margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 60px;">Point</th>
                            <th>Z Position (inches)</th>
                            <th>Radius (inches)</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pointsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                                No points defined. Click "Add Point" to start.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <canvas id="profileCanvas" width="800" height="400"></canvas>
            
            <div class="info-panel" id="profileInfo" style="display: none;">
                <div class="info-row">
                    <span>Points:</span>
                    <span id="pointCount">0</span>
                </div>
                <div class="info-row">
                    <span>Max Radius:</span>
                    <span id="maxRadius">0.000"</span>
                </div>
                <div class="info-row">
                    <span>Profile Length (Z):</span>
                    <span id="profileLength">0.000"</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">3. Generate G-code</div>
            <button class="button button-success" id="generateBtn" disabled>Generate G-code</button>
            <button class="button button-success" id="downloadBtn" disabled>Download G-code</button>
        </div>
    </div>

    <script>
        // Prevent wheel events on number inputs
        document.addEventListener('wheel', function(e) {
            if (document.activeElement.type === 'number') {
                document.activeElement.blur();
            }
        });
        
        let profilePoints = [];
        let generatedGCode = null;
        
        const canvas = document.getElementById('profileCanvas');
        const ctx = canvas.getContext('2d');
        
        function addPoint(z = 0, radius = 0.25) {
            const tbody = document.getElementById('pointsTableBody');
            
            // Remove "no points" message
            if (profilePoints.length === 0) {
                tbody.innerHTML = '';
            }
            
            const index = profilePoints.length;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="font-weight: 600;">${index + 1}</td>
                <td><input type="number" class="point-input point-z" value="${z.toFixed(4)}" step="0.001"></td>
                <td><input type="number" class="point-input point-radius" value="${radius.toFixed(4)}" step="0.001" min="0"></td>
                <td style="text-align: center;">
                    <button class="button button-danger" onclick="deletePoint(${index})">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
            
            profilePoints.push({ z: z, radius: radius });
            
            // Add event listeners
            const zInput = row.querySelector('.point-z');
            const radiusInput = row.querySelector('.point-radius');
            
            zInput.addEventListener('input', () => {
                profilePoints[index].z = parseFloat(zInput.value) || 0;
                updateVisualization();
            });
            
            radiusInput.addEventListener('input', () => {
                profilePoints[index].radius = parseFloat(radiusInput.value) || 0;
                updateVisualization();
            });
            
            updateVisualization();
        }
        
        function deletePoint(index) {
            profilePoints.splice(index, 1);
            rebuildTable();
        }
        
        function rebuildTable() {
            const tbody = document.getElementById('pointsTableBody');
            const tempPoints = [...profilePoints];
            profilePoints = [];
            tbody.innerHTML = '';
            
            if (tempPoints.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #999;">
                            No points defined. Click "Add Point" to start.
                        </td>
                    </tr>
                `;
                updateVisualization();
                return;
            }
            
            tempPoints.forEach(p => addPoint(p.z, p.radius));
        }
        
        document.getElementById('addPointBtn').addEventListener('click', () => {
            const lastZ = profilePoints.length > 0 ? profilePoints[profilePoints.length - 1].z : 0;
            addPoint(lastZ + 0.1, 0.25);
        });
        
        document.getElementById('clearPointsBtn').addEventListener('click', () => {
            if (profilePoints.length > 0 && !confirm('Clear all points?')) return;
            profilePoints = [];
            rebuildTable();
        });
        
        function updateVisualization() {
            drawProfile();
            updateInfo();
        }
        
        function drawProfile() {
            const scale = 300;
            const offsetX = 50;
            const offsetY = canvas.height - 50;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw axes
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(offsetX, offsetY);
            ctx.lineTo(canvas.width - 50, offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(offsetX, offsetY);
            ctx.lineTo(offsetX, 50);
            ctx.stroke();
            
            ctx.fillStyle = '#333';
            ctx.font = '12px sans-serif';
            ctx.fillText('Z (along cylinder)', canvas.width - 150, offsetY + 20);
            ctx.fillText('X (radius)', offsetX + 10, 40);
            
            // Draw grid
            ctx.strokeStyle = '#f0f0f0';
            for (let i = 0; i <= 3; i++) {
                const x = offsetX + i * scale * 0.25;
                ctx.beginPath();
                ctx.moveTo(x, offsetY);
                ctx.lineTo(x, 50);
                ctx.stroke();
                
                ctx.fillStyle = '#999';
                ctx.font = '10px sans-serif';
                ctx.fillText((i * 0.25).toFixed(2), x - 10, offsetY + 15);
            }
            
            for (let i = 0; i <= 3; i++) {
                const y = offsetY - i * scale * 0.25;
                ctx.beginPath();
                ctx.moveTo(offsetX, y);
                ctx.lineTo(canvas.width - 50, y);
                ctx.stroke();
                
                ctx.fillStyle = '#999';
                ctx.fillText((i * 0.25).toFixed(2), offsetX - 35, y + 5);
            }
            
            if (profilePoints.length === 0) return;
            
            // Draw profile
            ctx.strokeStyle = '#2196F3';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            profilePoints.forEach((p, i) => {
                const px = offsetX + p.z * scale;
                const py = offsetY - p.radius * scale;
                
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            
            ctx.stroke();
            
            // Draw points
            ctx.fillStyle = '#2196F3';
            profilePoints.forEach((p, i) => {
                const px = offsetX + p.z * scale;
                const py = offsetY - p.radius * scale;
                
                ctx.beginPath();
                ctx.arc(px, py, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw point number
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 10px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i + 1, px, py);
                ctx.fillStyle = '#2196F3';
            });
        }
        
        function updateInfo() {
            if (profilePoints.length === 0) {
                document.getElementById('profileInfo').style.display = 'none';
                document.getElementById('generateBtn').disabled = true;
                return;
            }
            
            document.getElementById('profileInfo').style.display = 'block';
            document.getElementById('pointCount').textContent = profilePoints.length;
            
            const maxRadius = Math.max(...profilePoints.map(p => p.radius));
            const minZ = Math.min(...profilePoints.map(p => p.z));
            const maxZ = Math.max(...profilePoints.map(p => p.z));
            
            document.getElementById('maxRadius').textContent = maxRadius.toFixed(4) + '"';
            document.getElementById('profileLength').textContent = (maxZ - minZ).toFixed(4) + '"';
            
            document.getElementById('generateBtn').disabled = profilePoints.length < 2;
        }
        
        document.getElementById('generateBtn').addEventListener('click', generateGCode);
        document.getElementById('downloadBtn').addEventListener('click', downloadGCode);
        
        function generateGCode() {
            if (profilePoints.length < 2) {
                alert('Need at least 2 points to generate G-code');
                return;
            }
            
            const toolDia = parseFloat(document.getElementById('toolDiameter').value);
            const toolRadius = toolDia / 2;
            const spindleRPM = parseInt(document.getElementById('spindleRPM').value);
            const aAxisSpeed = parseFloat(document.getElementById('aAxisSpeed').value);
            const feedRate = parseFloat(document.getElementById('feedRate').value);
            const depthPerPass = parseFloat(document.getElementById('depthPerPass').value);
            
            // Apply tool offset
            const offsetPoints = profilePoints.map(p => ({
                z: p.z,
                radius: p.radius + toolRadius
            }));
            
            // Sort by Z
            offsetPoints.sort((a, b) => a.z - b.z);
            
            const maxZ = Math.max(...offsetPoints.map(p => p.z));
            const numPasses = Math.ceil(maxZ / depthPerPass);
            
            let gcode = [];
            gcode.push('%');
            gcode.push('(CYLINDRICAL PROFILE - CNC TURNING)');
            gcode.push(`(TOOL DIA: ${toolDia}")`);
            gcode.push(`(SPINDLE: ${spindleRPM} RPM)`);
            gcode.push(`(A-AXIS: ${aAxisSpeed} deg/min continuous)`);
            gcode.push(`(FEED: ${feedRate} IPM)`);
            gcode.push(`(PASSES: ${numPasses})`);
            gcode.push('');
            gcode.push('G90 G94 G17');
            gcode.push('G20');
            gcode.push('G53 G0 Z-0.5');
            gcode.push('T1 M6');
            gcode.push(`S${spindleRPM} M3`);
            gcode.push('G54');
            gcode.push('M8');
            gcode.push('');
            gcode.push('G0 A0.0');
            gcode.push('');
            
            for (let pass = 1; pass <= numPasses; pass++) {
                const currentMaxZ = Math.min(pass * depthPerPass, maxZ);
                
                gcode.push(`(PASS ${pass} - Z depth: ${currentMaxZ.toFixed(4)})`);
                
                // Rapid to start
                gcode.push(`G0 X${(offsetPoints[0].radius + 0.1).toFixed(4)}`);
                gcode.push(`G0 Z${(offsetPoints[0].z - 0.05).toFixed(4)}`);
                
                // Feed in
                gcode.push(`G1 X${offsetPoints[0].radius.toFixed(4)} F${feedRate}`);
                gcode.push(`G1 Z${offsetPoints[0].z.toFixed(4)}`);
                
                // Follow profile with A rotation
                let currentAngle = 0;
                const degreesPerInch = aAxisSpeed / feedRate;
                
                for (let i = 1; i < offsetPoints.length; i++) {
                    const p = offsetPoints[i];
                    
                    if (p.z > currentMaxZ) break;
                    
                    const deltaZ = p.z - offsetPoints[i-1].z;
                    currentAngle += deltaZ * degreesPerInch;
                    
                    gcode.push(`G1 X${p.radius.toFixed(4)} Z${p.z.toFixed(4)} A${currentAngle.toFixed(3)}`);
                }
                
                // Retract
                gcode.push(`G0 X${(offsetPoints[0].radius + 0.2).toFixed(4)}`);
                gcode.push('G0 Z0.0');
                gcode.push('');
            }
            
            gcode.push('G0 A0.0');
            gcode.push('M5');
            gcode.push('M9');
            gcode.push('G53 G0 Z-0.5');
            gcode.push('M30');
            gcode.push('%');
            
            generatedGCode = gcode.join('\n');
            alert(`G-code generated!\nPasses: ${numPasses}`);
            document.getElementById('downloadBtn').disabled = false;
        }
        
        function downloadGCode() {
            if (!generatedGCode) return;
            const blob = new Blob([generatedGCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cylindrical_turning.nc';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Draw initial empty canvas
        drawProfile();
    </script>
</body>
</html>
